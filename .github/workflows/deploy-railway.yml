name: ğŸš€ Deploy to Railway with Database Fix

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_database_reset:
        description: 'Force complete database reset (WARNING: Deletes all data)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Railway
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build Application
        run: pnpm build
        env:
          NODE_ENV: production

      - name: ğŸ”§ Setup Railway CLI
        run: |
          npm install -g @railway/cli
          railway --version

      - name: ğŸ” Login to Railway
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸš€ Deploy to Railway
        run: |
          railway up --service ${{ secrets.RAILWAY_SERVICE_NAME || 'app' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: â±ï¸ Wait for Deployment
        run: |
          echo "Waiting for Railway deployment to be ready..."
          sleep 30
          
          # Wait for app to be healthy (max 5 minutes)
          for i in {1..30}; do
            echo "Checking deployment status... ($i/30)"
            
            # Get deployment URL
            DEPLOYMENT_URL=$(railway variables get RAILWAY_PUBLIC_DOMAIN --service ${{ secrets.RAILWAY_SERVICE_NAME || 'app' }})
            
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "Deployment URL: https://$DEPLOYMENT_URL"
              
              # Test health endpoint
              if curl -f "https://$DEPLOYMENT_URL/health" > /dev/null 2>&1; then
                echo "âœ… Application is healthy!"
                break
              else
                echo "â³ Application not ready yet..."
              fi
            fi
            
            sleep 10
          done

      - name: ğŸ”§ Fix Database Issues
        run: |
          echo "ğŸ”§ Running database fix script..."
          
          if [ "${{ github.event.inputs.force_database_reset }}" = "true" ]; then
            echo "âš ï¸ Force database reset requested!"
            railway run -- node scripts/drop-all-tables.cjs
          fi
          
          # Run the comprehensive database fix
          railway run -- node scripts/fix-railway-database.js
          
          echo "âœ… Database fix completed!"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ‘¤ Create Admin User
        run: |
          echo "ğŸ‘¤ Creating admin user..."
          railway run -- node scripts/ensure-admin.mjs
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: âœ… Verify Database
        run: |
          echo "ğŸ” Verifying database integrity..."
          railway run -- node scripts/verify-database.js
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ§ª Run Application Tests
        run: |
          echo "ğŸ§ª Running application tests..."
          railway run -- pnpm test || echo "âš ï¸ Tests failed but deployment continues"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ‰ Deployment Summary"
          echo "===================="
          
          # Get deployment URL
          DEPLOYMENT_URL=$(railway variables get RAILWAY_PUBLIC_DOMAIN --service ${{ secrets.RAILWAY_SERVICE_NAME || 'app' }})
          
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "ğŸŒ Application URL: https://$DEPLOYMENT_URL"
            echo "ğŸ¥ Health Check: https://$DEPLOYMENT_URL/health"
            echo "ğŸ‘¤ Admin Login: https://$DEPLOYMENT_URL/admin"
          fi
          
          echo "ğŸ“Š Database Status: Verified and ready"
          echo "ğŸ‘¤ Admin User: Created (check logs for credentials)"
          echo "ğŸ”§ All migrations: Applied successfully"
          
          # Get admin credentials from logs
          echo ""
          echo "ğŸ“‹ Admin Credentials (from recent logs):"
          railway logs --service ${{ secrets.RAILWAY_SERVICE_NAME || 'app' }} --tail 50 | grep -E "(Admin|Username|Password|Credentials)" || echo "Check Railway logs for admin credentials"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ“± Send Notification (Optional)
        if: always()
        run: |
          # You can add Discord/Slack notifications here
          echo "Deployment completed with status: ${{ job.status }}"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  health-check:
    runs-on: ubuntu-latest
    name: Post-Deployment Health Check
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ”§ Setup Railway CLI
        run: |
          npm install -g @railway/cli
          railway --version

      - name: ğŸ” Login to Railway
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ¥ Final Health Check
        run: |
          echo "ğŸ¥ Running final health check..."
          
          DEPLOYMENT_URL=$(railway variables get RAILWAY_PUBLIC_DOMAIN --service ${{ secrets.RAILWAY_SERVICE_NAME || 'app' }})
          
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "Testing: https://$DEPLOYMENT_URL/health"
            
            # Test health endpoint
            if curl -f "https://$DEPLOYMENT_URL/health" 2>/dev/null | grep -q "ok"; then
              echo "âœ… Health check passed!"
              echo "ğŸŒ Application is live at: https://$DEPLOYMENT_URL"
            else
              echo "âŒ Health check failed!"
              echo "ğŸ” Checking application logs..."
              railway logs --service ${{ secrets.RAILWAY_SERVICE_NAME || 'app' }} --tail 20
              exit 1
            fi
          else
            echo "âŒ Could not get deployment URL"
            exit 1
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ“Š Database Health Check
        run: |
          echo "ğŸ” Checking database health..."
          railway run -- node scripts/verify-database.js
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
